
# Base de datos

```sql
-- =============================================
-- Script SQL Server - Schema Final Corregido
-- Incluye: Constraints, Validaciones e Índices
-- =============================================

-- Tablas Base
CREATE TABLE [DISCIPLINA] (
 [ID_DIS] INTEGER NOT NULL IDENTITY(1,1),
 [NOMBRE] VARCHAR(255) NOT NULL,
 PRIMARY KEY([ID_DIS])
);
GO

CREATE TABLE [ROL] (
 [ID_ROL] INTEGER NOT NULL IDENTITY(1,1),
 [NOMBRE] VARCHAR(255) NOT NULL,
 [ADMINISTRADOR] BIT NOT NULL,
 PRIMARY KEY([ID_ROL])
);
GO

CREATE TABLE [USUARIO] (
 [ID_USR] INTEGER NOT NULL IDENTITY(1,1),
 [ID_ROL] INTEGER,
 [ID_DIS] INTEGER,
 [NOMBRE] VARCHAR(255) NOT NULL,
 [USUARIO] VARCHAR(255) NOT NULL,
 [CONTRASENA] VARCHAR(255) NOT NULL,
 PRIMARY KEY([ID_USR]),
 CONSTRAINT UQ_USUARIO_LOGIN UNIQUE([USUARIO])
);
GO

CREATE TABLE [AUDITORIA] (
 [ID_AUD] INTEGER NOT NULL IDENTITY(1,1),
 [TABLA] VARCHAR(255) NOT NULL,
 [DIAHORA] DATETIME NOT NULL DEFAULT GETDATE(),
 [CAMPO] VARCHAR(255) NOT NULL,
 [VAL_ANTES] VARCHAR(255) NOT NULL,
 [VA_DESPUES] VARCHAR(255) NOT NULL,
 [ID_USR] INTEGER,
 PRIMARY KEY([ID_AUD])
);
GO

CREATE TABLE [ENTREGA] (
 [IDE] INTEGER NOT NULL IDENTITY(1,1),
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 [ORDEN] INTEGER NOT NULL,
 PRIMARY KEY([IDE])
);
GO

CREATE TABLE [REP_ENTREGA] (
 [ID_RENT] INTEGER NOT NULL IDENTITY(1,1),
 [IDPM] INTEGER NOT NULL,
 [IDE] INTEGER NOT NULL,
 PRIMARY KEY([ID_RENT])
);
GO

CREATE TABLE [JERARQUIA] (
 [IDJ] INTEGER NOT NULL IDENTITY(1,1),
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDJ])
);
GO

CREATE TABLE [NIVEL] (
 [IDN] INTEGER NOT NULL IDENTITY(1,1),
 [IDJ] INTEGER NOT NULL,
 [IDNP] INTEGER NULL,
 [NOMBRE] VARCHAR(255) NOT NULL,
 [PLANTILLA] BIT NOT NULL DEFAULT 0,
 [NROPM] INTEGER NOT NULL DEFAULT 0,
 PRIMARY KEY([IDN])
);
GO

CREATE TABLE [ATRIBUTO] (
 [IDT] INTEGER NOT NULL IDENTITY(1,1),
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDT])
);
GO

CREATE TABLE [ACTIVIDAD_NIVEL] (
 [IDA] INTEGER NOT NULL IDENTITY(1,1),
 [IDN] INTEGER NOT NULL,
 [IDT] INTEGER,
 [ORDEN] INTEGER NOT NULL,
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDA])
);
GO

CREATE TABLE [ATRIBUTO_VALOR] (
 [IDAV] INTEGER NOT NULL IDENTITY(1,1),
 [IDA] INTEGER NOT NULL,
 [VALOR] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDAV])
);
GO

CREATE TABLE [PM] (
 [IDPM] INTEGER NOT NULL IDENTITY(1,1),
 [IDN] INTEGER NOT NULL,
 [NRO] INTEGER NOT NULL,
 [CONJUNTO] INTEGER NOT NULL,
 [PROGRAMACION] DATETIME NOT NULL,
 [ESTADO] VARCHAR(255) NOT NULL,
 [HOROMETRO] INTEGER NOT NULL DEFAULT 0,
 [INICIO] DATETIME NOT NULL,
 [FIN] DATETIME NOT NULL,
 PRIMARY KEY([IDPM])
);
GO

CREATE TABLE [REP_NIVEL] (
 [IDRN] INTEGER NOT NULL IDENTITY(1,1),
 [IDPM] INTEGER NOT NULL,
 [IDN] INTEGER NOT NULL,
 [IDJ] INTEGER NOT NULL,
 [IDNP] INTEGER NOT NULL,
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDRN]),
 -- NOTA: IDN, IDJ, IDNP son datos históricos (snapshot), NO foreign keys
);
GO

CREATE TABLE [MODO_FALLA] (
 [IDMF] INTEGER NOT NULL IDENTITY(1,1),
 [IDRN] INTEGER,
 [MODOFALLA] VARCHAR(255) NOT NULL,
 PRIMARY KEY([IDMF])
);
GO

CREATE TABLE [REP_ACTIVIDAD] (
 [IDRA] INTEGER NOT NULL IDENTITY(1,1),
 [IDRN] INTEGER NOT NULL,
 [ORDEN] INTEGER NOT NULL,
 [DESCRIPCION] VARCHAR(255) NOT NULL,
 [REFERENCIA] VARCHAR(255) NOT NULL,
 [DURACION] INTEGER NOT NULL,
 PRIMARY KEY([IDRA])
);
GO

CREATE TABLE [USUARIO_PM] (
 [IDUPM] INTEGER NOT NULL IDENTITY(1,1),
 [IDPM] INTEGER NOT NULL,
 [ID_USR] INTEGER NOT NULL,
 PRIMARY KEY([IDUPM])
);
GO

CREATE TABLE [ACTIVIDAD] (
 [ID_ACT] INTEGER NOT NULL IDENTITY(1,1),
 [TITULO] VARCHAR(255) NOT NULL,
 [REFERENCIA] VARCHAR(255) NOT NULL,
 [DURACION] INTEGER NOT NULL,
 PRIMARY KEY([ID_ACT])
);
GO

CREATE TABLE [EQUIPO] (
 [ID_EQU] INTEGER NOT NULL IDENTITY(1,1),
 [NOMBRE] VARCHAR(255) NOT NULL,
 PRIMARY KEY([ID_EQU])
);
GO

CREATE TABLE [REPUESTO] (
 [ID_REP] INTEGER NOT NULL IDENTITY(1,1),
 [NOMBRE] VARCHAR(255) NOT NULL,
 [NROPARTE] VARCHAR(50) NOT NULL,
 PRIMARY KEY([ID_REP])
);
GO

CREATE TABLE [HERRAMIENTA] (
 [ID_HERR] INTEGER NOT NULL IDENTITY(1,1),
 [NOMBRE] VARCHAR(255) NOT NULL,
 PRIMARY KEY([ID_HERR])
);
GO

CREATE TABLE [COMPLEMENTO] (
 [ID_COM] INTEGER NOT NULL IDENTITY(1,1),
 [IDA] INTEGER NOT NULL,
 [ID_EQU] INTEGER,
 [ID_REP] INTEGER,
 [ID_HERR] INTEGER,
 PRIMARY KEY([ID_COM])
);
GO

-- =============================================
-- Foreign Keys
-- =============================================

-- USUARIO
ALTER TABLE [USUARIO]
ADD FOREIGN KEY([ID_ROL])
REFERENCES [ROL]([ID_ROL])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [USUARIO]
ADD FOREIGN KEY([ID_DIS])
REFERENCES [DISCIPLINA]([ID_DIS])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- AUDITORIA
ALTER TABLE [AUDITORIA]
ADD FOREIGN KEY([ID_USR])
REFERENCES [USUARIO]([ID_USR])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- MODO_FALLA
ALTER TABLE [MODO_FALLA]
ADD FOREIGN KEY([IDRN])
REFERENCES [REP_NIVEL]([IDRN])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- REP_ACTIVIDAD
ALTER TABLE [REP_ACTIVIDAD]
ADD FOREIGN KEY([IDRN])
REFERENCES [REP_NIVEL]([IDRN])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- REP_NIVEL (solo IDPM es FK, los demás son datos históricos)
ALTER TABLE [REP_NIVEL]
ADD FOREIGN KEY([IDPM])
REFERENCES [PM]([IDPM])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- USUARIO_PM
ALTER TABLE [USUARIO_PM]
ADD FOREIGN KEY([ID_USR])
REFERENCES [USUARIO]([ID_USR])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [USUARIO_PM]
ADD FOREIGN KEY([IDPM])
REFERENCES [PM]([IDPM])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- REP_ENTREGA
ALTER TABLE [REP_ENTREGA]
ADD FOREIGN KEY([IDE])
REFERENCES [ENTREGA]([IDE])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [REP_ENTREGA]
ADD FOREIGN KEY([IDPM])
REFERENCES [PM]([IDPM])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- COMPLEMENTO
ALTER TABLE [COMPLEMENTO]
ADD FOREIGN KEY([IDA])
REFERENCES [ACTIVIDAD_NIVEL]([IDA])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [COMPLEMENTO]
ADD FOREIGN KEY([ID_EQU])
REFERENCES [EQUIPO]([ID_EQU])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [COMPLEMENTO]
ADD FOREIGN KEY([ID_REP])
REFERENCES [REPUESTO]([ID_REP])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [COMPLEMENTO]
ADD FOREIGN KEY([ID_HERR])
REFERENCES [HERRAMIENTA]([ID_HERR])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- NIVEL
ALTER TABLE [NIVEL]
ADD FOREIGN KEY([IDJ])
REFERENCES [JERARQUIA]([IDJ])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [NIVEL]
ADD FOREIGN KEY([IDNP])
REFERENCES [NIVEL]([IDN])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- PM
ALTER TABLE [PM]
ADD FOREIGN KEY([IDN])
REFERENCES [NIVEL]([IDN])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- ACTIVIDAD_NIVEL
ALTER TABLE [ACTIVIDAD_NIVEL]
ADD FOREIGN KEY([IDN])
REFERENCES [NIVEL]([IDN])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

ALTER TABLE [ACTIVIDAD_NIVEL]
ADD FOREIGN KEY([IDT])
REFERENCES [ATRIBUTO]([IDT])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- ATRIBUTO_VALOR
ALTER TABLE [ATRIBUTO_VALOR]
ADD FOREIGN KEY([IDA])
REFERENCES [ACTIVIDAD_NIVEL]([IDA])
ON UPDATE NO ACTION ON DELETE NO ACTION;
GO

-- =============================================
-- CHECK CONSTRAINTS
-- =============================================

-- Validar que FIN sea después de INICIO
ALTER TABLE [PM]
ADD CONSTRAINT CHK_PM_FECHAS
CHECK ([FIN] >= [INICIO]);
GO

-- Validar que HOROMETRO sea positivo
ALTER TABLE [PM]
ADD CONSTRAINT CHK_PM_HOROMETRO
CHECK ([HOROMETRO] >= 0);
GO

-- COMPLEMENTO debe tener exactamente UNO de los tres tipos
ALTER TABLE [COMPLEMENTO]
ADD CONSTRAINT CHK_COMPLEMENTO_TIPO
CHECK (
    (ID_EQU IS NOT NULL AND ID_REP IS NULL AND ID_HERR IS NULL) OR
    (ID_EQU IS NULL AND ID_REP IS NOT NULL AND ID_HERR IS NULL) OR
    (ID_EQU IS NULL AND ID_REP IS NULL AND ID_HERR IS NOT NULL)
);
GO

-- NIVEL no puede ser padre de sí mismo
ALTER TABLE [NIVEL]
ADD CONSTRAINT CHK_NIVEL_NO_AUTOREFERENCIA
CHECK ([IDN] <> [IDNP] OR [IDNP] IS NULL);
GO

-- ORDEN debe ser positivo
ALTER TABLE [ACTIVIDAD_NIVEL]
ADD CONSTRAINT CHK_ACTIVIDAD_ORDEN
CHECK ([ORDEN] > 0);
GO

ALTER TABLE [REP_ACTIVIDAD]
ADD CONSTRAINT CHK_REP_ACTIVIDAD_ORDEN
CHECK ([ORDEN] > 0);
GO

ALTER TABLE [ENTREGA]
ADD CONSTRAINT CHK_ENTREGA_ORDEN
CHECK ([ORDEN] > 0);
GO

-- DURACION debe ser positiva
ALTER TABLE [REP_ACTIVIDAD]
ADD CONSTRAINT CHK_REP_ACTIVIDAD_DURACION
CHECK ([DURACION] > 0);
GO

ALTER TABLE [ACTIVIDAD]
ADD CONSTRAINT CHK_ACTIVIDAD_DURACION
CHECK ([DURACION] > 0);
GO

-- =============================================
-- UNIQUE INDEXES (Evitar duplicados)
-- =============================================

-- Evitar duplicar mismo PM-Entrega
CREATE UNIQUE INDEX UX_REP_ENTREGA_PM_IDE
ON [REP_ENTREGA]([IDPM], [IDE]);
GO

-- Evitar duplicar mismo Usuario-PM
CREATE UNIQUE INDEX UX_USUARIO_PM
ON [USUARIO_PM]([IDPM], [ID_USR]);
GO

-- Evitar nombres duplicados en tablas de catálogo
CREATE UNIQUE INDEX UX_ROL_NOMBRE
ON [ROL]([NOMBRE]);
GO

CREATE UNIQUE INDEX UX_DISCIPLINA_NOMBRE
ON [DISCIPLINA]([NOMBRE]);
GO

CREATE UNIQUE INDEX UX_JERARQUIA_DESCRIPCION
ON [JERARQUIA]([DESCRIPCION]);
GO

-- =============================================
-- ÍNDICES DE RENDIMIENTO
-- =============================================

-- Para búsquedas frecuentes
CREATE INDEX IX_PM_ESTADO ON [PM]([ESTADO]);
GO

CREATE INDEX IX_PM_PROGRAMACION ON [PM]([PROGRAMACION]);
GO

CREATE INDEX IX_AUDITORIA_DIAHORA ON [AUDITORIA]([DIAHORA]);
GO

CREATE INDEX IX_AUDITORIA_TABLA ON [AUDITORIA]([TABLA]);
GO

-- =============================================
-- COMENTARIOS SOBRE TABLAS ESPECIALES
-- =============================================

-- NOTA: La tabla ACTIVIDAD no tiene relaciones definidas
-- Posiblemente sea una tabla legacy o requiera revisión del modelo
-- Si es una plantilla/catálogo, considerar relacionarla con ACTIVIDAD_NIVEL

PRINT 'Schema creado exitosamente';
PRINT 'ADVERTENCIA: Tabla ACTIVIDAD no tiene relaciones definidas';
GOT
```
